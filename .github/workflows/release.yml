name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ (å¦‚ v0.1, v1.0.0)

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build extension
      run: npm run build

    - name: Create release package
      run: |
        cd dist
        zip -r ../TabMaster-Pro-${{ github.ref_name }}.zip .
        cd ..

    - name: Generate changelog
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

        if [ -z "$PREV_TAG" ]; then
          # å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œè·å–æ‰€æœ‰æäº¤
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" --reverse)
        else
          # è·å–ä¸¤ä¸ªæ ‡ç­¾ä¹‹é—´çš„æäº¤
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD --reverse)
        fi

        # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: TabMaster-Pro-${{ github.ref_name }}.zip
        body: |
          ## TabMaster Pro ${{ github.ref_name }}

          ### ğŸš€ æ›´æ–°å†…å®¹ / What's Changed
          ${{ steps.changelog.outputs.CHANGELOG }}

          ### ğŸ“¦ å®‰è£…æ–¹æ³• / Installation
          1. ä¸‹è½½ `TabMaster-Pro-${{ github.ref_name }}.zip` / Download the ZIP file
          2. è§£å‹æ–‡ä»¶ / Extract the archive
          3. æ‰“å¼€ Chrome æ‰©å±•ç®¡ç†é¡µé¢ `chrome://extensions/` / Open Chrome extensions page
          4. å¼€å¯å¼€å‘è€…æ¨¡å¼ / Enable Developer mode
          5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº" / Click "Load unpacked"
          6. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹ / Select the extracted folder

          ### ğŸ”§ æŠ€æœ¯ä¿¡æ¯ / Technical Info
          - **æ„å»ºæ—¶é—´** / Build Time: ${{ github.run_id }}
          - **æäº¤å“ˆå¸Œ** / Commit: ${{ github.sha }}
          - **Node.jsç‰ˆæœ¬** / Node.js Version: 20
          - **æ„å»ºå·¥å…·** / Build Tool: Vite + npm
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: extension-build-${{ github.ref_name }}
        path: |
          dist/
          TabMaster-Pro-${{ github.ref_name }}.zip
        retention-days: 30